#!/bin/bash
#
# EC2 User Data Script for Sovereign Rollup Deployment
# This script is executed automatically when an EC2 instance launches
#
# This example shows how to deploy the Sovereign rollup using ansible-pull
# CDK should generate this script with actual values substituted
#
# IMPORTANT: This script runs as root during instance initialization

set -euo pipefail

# ============================================================================
# CONFIGURATION - CDK should substitute these values
# ============================================================================

# Ansible repository configuration
ANSIBLE_REPO_URL="https://github.com/Sovereign-Labs/sov-rollup-starter-ansible.git"
ANSIBLE_REPO_BRANCH="main"

# Deployment configuration
data_availability_role="mock_da"  # or "celestia"
ZKVM_ROLE="mock_zkvm"             # or "risc0"
SWITCHES="cr"                      # "cr" for full setup, "r" for rollup only
DEBUG_BUILD="true"                 # "true" or "false"
ROLLUP_COMMIT_HASH="770a88a25576640b1e76b9385bf61b05452d60dd"

# Celestia configuration (required if data_availability_role=celestia)
DA_START_HEIGHT="8877186"
ROLLUP_BATCH_NAMESPACE="sov-b-dev8"
ROLLUP_PROOF_NAMESPACE="sov-p-dev8"
CELESTIA_RPC_URL="https://rpc-mocha.pops.one"
CELESTIA_GRPC_URL="grpc-mocha.pops.one:443"
DA_ROLLUP_ADDRESS="celestia1jk6xx55wum73al8f2mp54x92uggqws8ksnjus2"

# Optional constants.toml overrides (leave empty to use rollup defaults)
ROLLUP_CHAIN_ID=""
ROLLUP_CHAIN_NAME=""
ROLLUP_HYPERLANE_BRIDGE_DOMAIN=""
ROLLUP_DEFERRED_SLOTS_COUNT=""

# Secrets (CDK should retrieve from AWS Secrets Manager or SSM)
# CELESTIA_GRPC_AUTH_TOKEN=""
# SIGNER_PRIVATE_KEY=""

# Optional: Custom host label for monitoring
CUSTOM_HOST_LABEL="${CUSTOM_HOST_LABEL:-$(ec2-metadata --instance-id | cut -d' ' -f2)}"

# ============================================================================
# LOGGING SETUP
# ============================================================================

LOG_FILE="/var/log/cloud-init-sovereign.log"
exec > >(tee -a "$LOG_FILE") 2>&1

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*"
}

log "=========================================="
log "Sovereign Rollup Cloud-Init - Starting"
log "=========================================="
log "Instance ID: $(ec2-metadata --instance-id || echo 'unknown')"
log "Instance Type: $(ec2-metadata --instance-type || echo 'unknown')"
log "Availability Zone: $(ec2-metadata --availability-zone || echo 'unknown')"
log "=========================================="

# ============================================================================
# BOOTSTRAP: Install Prerequisites
# ============================================================================

log "Phase 1: Installing prerequisites..."

# Update package lists
log "Updating package lists..."
apt-get update -qq

# Install required packages
log "Installing software-properties-common..."
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq software-properties-common

# Add Ansible PPA
log "Adding Ansible PPA..."
add-apt-repository --yes --update ppa:ansible/ansible

# Install core dependencies
log "Installing ansible, git, python3..."
DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
    ansible \
    git \
    python3 \
    python3-pip \
    ca-certificates \
    curl \
    jq

# Verify installations
ANSIBLE_VER=$(ansible --version | head -n1)
log "✓ Ansible installed: $ANSIBLE_VER"

GIT_VER=$(git --version)
log "✓ Git installed: $GIT_VER"

# ============================================================================
# PREPARE RUNTIME VARIABLES
# ============================================================================

log "Phase 2: Preparing runtime variables..."

# Create vars directory
mkdir -p /tmp/ansible-sovereign/vars
RUNTIME_VARS_FILE="/tmp/ansible-sovereign/vars/runtime_vars.yaml"

# Generate runtime_vars.yaml
log "Generating runtime_vars.yaml..."
cat > "$RUNTIME_VARS_FILE" << EOF
---
# Runtime variables for Sovereign Rollup deployment
# Generated by cloud-init on $(date -u +"%Y-%m-%d %H:%M:%S UTC")

# Deployment configuration
data_availability_role: "$data_availability_role"
switches: "$SWITCHES"
zkvm_role: "$ZKVM_ROLE"
debug: $DEBUG_BUILD
rollup_commit_hash: "$ROLLUP_COMMIT_HASH"

# DA configuration
da_start_height: $DA_START_HEIGHT

# Monitoring
custom_host_label: "$CUSTOM_HOST_LABEL"
opentelemetry_mode: "logs"
EOF

# Add Celestia-specific configuration if needed
if [[ "$data_availability_role" == "celestia" ]]; then
    log "Adding Celestia configuration..."
    cat >> "$RUNTIME_VARS_FILE" << EOF

# Celestia DA configuration
rollup_batch_namespace: "$ROLLUP_BATCH_NAMESPACE"
rollup_proof_namespace: "$ROLLUP_PROOF_NAMESPACE"
celestia_rpc_url: "$CELESTIA_RPC_URL"
celestia_grpc_url: "$CELESTIA_GRPC_URL"
da_rollup_address: "$DA_ROLLUP_ADDRESS"
EOF

    # Add secrets if provided (CDK should inject these)
    if [[ -n "${CELESTIA_GRPC_AUTH_TOKEN:-}" ]]; then
        cat >> "$RUNTIME_VARS_FILE" << EOF
celestia_grpc_auth_token: "$CELESTIA_GRPC_AUTH_TOKEN"
EOF
    fi

    if [[ -n "${SIGNER_PRIVATE_KEY:-}" ]]; then
        cat >> "$RUNTIME_VARS_FILE" << EOF
signer_private_key: "$SIGNER_PRIVATE_KEY"
EOF
    fi
fi

# Add optional constants.toml overrides if provided
if [[ -n "${ROLLUP_CHAIN_ID:-}" ]]; then
    cat >> "$RUNTIME_VARS_FILE" << EOF
rollup_chain_id: $ROLLUP_CHAIN_ID
EOF
fi

if [[ -n "${ROLLUP_CHAIN_NAME:-}" ]]; then
    cat >> "$RUNTIME_VARS_FILE" << EOF
rollup_chain_name: "$ROLLUP_CHAIN_NAME"
EOF
fi

if [[ -n "${ROLLUP_HYPERLANE_BRIDGE_DOMAIN:-}" ]]; then
    cat >> "$RUNTIME_VARS_FILE" << EOF
rollup_hyperlane_bridge_domain: $ROLLUP_HYPERLANE_BRIDGE_DOMAIN
EOF
fi

if [[ -n "${ROLLUP_DEFERRED_SLOTS_COUNT:-}" ]]; then
    cat >> "$RUNTIME_VARS_FILE" << EOF
rollup_deferred_slots_count: $ROLLUP_DEFERRED_SLOTS_COUNT
EOF
fi

# Secure the file (contains secrets)
chmod 600 "$RUNTIME_VARS_FILE"
log "✓ Runtime variables prepared at: $RUNTIME_VARS_FILE"

# ============================================================================
# ANSIBLE-PULL DEPLOYMENT
# ============================================================================

log "Phase 3: Running ansible-pull deployment..."

# Change to working directory
cd /tmp/ansible-sovereign

# Run ansible-pull
log "Executing ansible-pull..."
log "Repository: $ANSIBLE_REPO_URL"
log "Branch: $ANSIBLE_REPO_BRANCH"
log "Playbook: local.yml"

ansible-pull \
    --url "$ANSIBLE_REPO_URL" \
    --checkout "$ANSIBLE_REPO_BRANCH" \
    --inventory inventory/localhost.ini \
    --extra-vars "@$RUNTIME_VARS_FILE" \
    local.yml

ANSIBLE_EXIT_CODE=$?

if [[ $ANSIBLE_EXIT_CODE -eq 0 ]]; then
    log "✓ Ansible deployment completed successfully!"
else
    log "✗ Ansible deployment failed with exit code: $ANSIBLE_EXIT_CODE"
    log "Check logs at: /var/log/cloud-init-output.log and $LOG_FILE"
    exit $ANSIBLE_EXIT_CODE
fi

# ============================================================================
# POST-DEPLOYMENT VERIFICATION
# ============================================================================

log "Phase 4: Verifying deployment..."

# Check if rollup service is running
if systemctl is-active --quiet rollup; then
    log "✓ Rollup service is running"
    systemctl status rollup --no-pager | head -10
else
    log "⚠ Rollup service is not running yet (may still be starting)"
fi

# Check if nginx is configured
if systemctl is-active --quiet nginx; then
    log "✓ Nginx is running"
else
    log "⚠ Nginx is not running"
fi

# Display useful information
log ""
log "=========================================="
log "Deployment Information"
log "=========================================="
log "Rollup HTTP Port: 12346"
log "Nginx Proxy Port: 8081"
log "Data Directory: /mnt/rollup"
log "Log Directory: /mnt/logs"
log ""
log "Useful commands:"
log "  sudo systemctl status rollup    # Check service status"
log "  sudo journalctl -u rollup -f    # View logs"
log "  curl http://localhost:12346/health  # Test API"
log "=========================================="

# Cleanup sensitive files
log "Cleaning up sensitive files..."
shred -vfz "$RUNTIME_VARS_FILE" || rm -f "$RUNTIME_VARS_FILE"

log "=========================================="
log "Cloud-init deployment completed!"
log "Full log: $LOG_FILE"
log "=========================================="

exit 0
