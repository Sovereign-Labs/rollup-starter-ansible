---
# =============================================================================
# Disk Setup (Profile-Based)
# =============================================================================
#
# Uses predefined disk profiles from disk_profiles dictionary.
# Set disk_profile variable to select: aws_raid_1, aws_raid_0, aws_ebs_backup_node, aws_ebs_backup_node_raid0, aws_simple, raid_manual, hetzner, none, custom
#
# For aws_raid_* profiles, disk paths are resolved from discovered instance store disks.
# For other profiles, disk paths are specified explicitly.
#
# Resolved disk_config contains:
#   - use_raid: Whether to create RAID array for rollup storage
#   - raid_level: RAID level (0=striped, 1=mirrored)
#   - raid_disks: List of disks for RAID (when use_raid=true)
#   - rollup_disk: Single disk for rollup (when use_raid=false)
#   - logs_disk: Disk for /mnt/logs (empty string = skip)
#   - da_disk: Disk for /mnt/da (empty string = skip)

# =============================================================================
# PHASE 1: Load and Validate Profile
# =============================================================================

- name: display selected disk profile
  debug:
    msg:
      - "===== Disk Configuration ====="
      - "Profile: {{ disk_profile }}{{ ' (auto-discovered)' if disk_config.auto_discover | default(false) else '' }}"
      - "Use RAID: {{ disk_config.use_raid | default(false) }}{{ ' (level ' + (disk_config.raid_level | string) + ')' if disk_config.use_raid | default(false) else '' }}"
      - "RAID disks: {{ disk_config.raid_disks | default([]) | join(', ') or 'N/A' }}"
      - "Rollup disk: {{ disk_config.rollup_disk | default('N/A') or 'N/A' }}"
      - "Logs disk: {{ disk_config.logs_disk | default('') or 'N/A (root volume)' }}"
      - "DA disk: {{ disk_config.da_disk | default('') or 'N/A (root volume)' }}"
      - "Snapshots disk: {{ disk_config.snapshots_disk | default('') or 'N/A' }}"
      - "Reformat: {{ reformat_disks | default(false) }}"

# =============================================================================
# PHASE 2: Validate Disks Exist
# =============================================================================

- name: validate RAID disks exist
  stat:
    path: "{{ item }}"
  register: raid_disk_check
  loop: "{{ disk_config.raid_disks | default([]) }}"
  when: disk_config.use_raid | default(false) | bool
  failed_when: not raid_disk_check.stat.exists

- name: validate rollup disk exists
  stat:
    path: "{{ disk_config.rollup_disk }}"
  register: rollup_disk_check
  when:
    - not (disk_config.use_raid | default(false) | bool)
    - disk_config.rollup_disk | default('') | length > 0
  failed_when: not rollup_disk_check.stat.exists

- name: validate logs disk exists
  stat:
    path: "{{ disk_config.logs_disk }}"
  register: logs_disk_check
  when: disk_config.logs_disk | default('') | length > 0
  failed_when: not logs_disk_check.stat.exists

- name: validate da disk exists
  stat:
    path: "{{ disk_config.da_disk }}"
  register: da_disk_check
  when: disk_config.da_disk | default('') | length > 0
  failed_when: not da_disk_check.stat.exists

- name: validate snapshots disk exists
  stat:
    path: "{{ disk_config.snapshots_disk }}"
  register: snapshots_disk_check
  when: disk_config.snapshots_disk | default('') | length > 0
  failed_when: not snapshots_disk_check.stat.exists

# =============================================================================
# PHASE 3: Check Current Mount State (for idempotency)
# =============================================================================

- name: check if rollup_storage_dir is already mounted
  shell: mountpoint -q {{ rollup_storage_dir }} && echo "mounted" || echo "not_mounted"
  register: rollup_mount_state
  changed_when: false
  become: true

- name: check if rollup_log_dir is already mounted
  shell: mountpoint -q {{ rollup_log_dir }} && echo "mounted" || echo "not_mounted"
  register: logs_mount_state
  changed_when: false
  become: true

- name: check if da_store is already mounted
  shell: mountpoint -q {{ da_store }} && echo "mounted" || echo "not_mounted"
  register: da_mount_state
  changed_when: false
  become: true

- name: check if snapshots_dir is already mounted
  shell: mountpoint -q {{ snapshots_dir }} && echo "mounted" || echo "not_mounted"
  register: snapshots_mount_state
  changed_when: false
  become: true

- name: check if RAID array exists
  shell: |
    if [ -e /dev/md/rollup ]; then
      mdadm --detail /dev/md/rollup > /dev/null 2>&1 && echo "exists" || echo "broken"
    else
      echo "none"
    fi
  register: raid_state
  changed_when: false
  become: true

- name: display current state
  debug:
    msg:
      - "===== Current Mount State ====="
      - "{{ rollup_storage_dir }}: {{ rollup_mount_state.stdout }}"
      - "{{ rollup_log_dir }}: {{ logs_mount_state.stdout }}"
      - "{{ da_store }}: {{ da_mount_state.stdout }}"
      - "{{ snapshots_dir }}: {{ snapshots_mount_state.stdout }}"
      - "RAID array: {{ raid_state.stdout }}"

# =============================================================================
# PHASE 4: Setup Rollup Storage (RAID-1 or Single Disk)
# =============================================================================

- name: unmount rollup storage for reformat
  mount:
    path: "{{ rollup_storage_dir }}"
    state: unmounted
  become: true
  when:
    - reformat_disks | default(false) | bool
    - rollup_mount_state.stdout == 'mounted'

- name: stop existing RAID array for reformat
  shell: mdadm --stop /dev/md/rollup || true
  become: true
  when:
    - reformat_disks | default(false) | bool
    - raid_state.stdout == 'exists'

- name: clear RAID superblocks for reformat
  shell: |
    mdadm --zero-superblock {{ item }} || true
    wipefs -a {{ item }} || true
  become: true
  loop: "{{ disk_config.raid_disks | default([]) }}"
  when:
    - reformat_disks | default(false) | bool
    - disk_config.use_raid | default(false) | bool

- name: create RAID array
  shell: |
    mdadm --create /dev/md/rollup \
      --level={{ disk_config.raid_level | default(1) }} \
      --raid-devices={{ disk_config.raid_disks | length }} \
      --name=rollup \
      --metadata=1.2 \
      --run \
      {{ disk_config.raid_disks | join(' ') }}
  become: true
  when:
    - disk_config.use_raid | default(false) | bool
    - raid_state.stdout != 'exists'
    - rollup_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: wait for RAID device
  wait_for:
    path: /dev/md/rollup
    state: present
    timeout: 30
  become: true
  when:
    - disk_config.use_raid | default(false) | bool
    - rollup_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: format RAID array
  filesystem:
    fstype: ext4
    dev: /dev/md/rollup
    force: "{{ reformat_disks | default(false) }}"
  become: true
  when:
    - disk_config.use_raid | default(false) | bool
    - rollup_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: get RAID UUID
  command: blkid -s UUID -o value /dev/md/rollup
  register: raid_uuid
  changed_when: false
  become: true
  when: disk_config.use_raid | default(false) | bool

- name: mount RAID array
  mount:
    path: "{{ rollup_storage_dir }}"
    src: "UUID={{ raid_uuid.stdout }}"
    fstype: ext4
    opts: "defaults,noatime"
    passno: "2"
    state: mounted
  become: true
  when:
    - disk_config.use_raid | default(false) | bool
    - rollup_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: check if RAID in mdadm.conf
  shell: grep -q "name=.*:rollup" /etc/mdadm/mdadm.conf && echo "exists" || echo "missing"
  register: mdadm_conf_state
  changed_when: false
  become: true
  when: disk_config.use_raid | default(false) | bool

- name: add RAID to mdadm.conf
  shell: mdadm --detail --scan >> /etc/mdadm/mdadm.conf
  become: true
  when:
    - disk_config.use_raid | default(false) | bool
    - mdadm_conf_state.stdout == 'missing'
  notify: update-initramfs

- name: format rollup disk
  filesystem:
    fstype: ext4
    dev: "{{ disk_config.rollup_disk }}"
    force: "{{ reformat_disks | default(false) }}"
  become: true
  when:
    - not (disk_config.use_raid | default(false) | bool)
    - disk_config.rollup_disk | default('') | length > 0
    - rollup_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: get rollup disk UUID
  command: blkid -s UUID -o value {{ disk_config.rollup_disk }}
  register: rollup_disk_uuid
  changed_when: false
  become: true
  when:
    - not (disk_config.use_raid | default(false) | bool)
    - disk_config.rollup_disk | default('') | length > 0

- name: mount rollup disk
  mount:
    path: "{{ rollup_storage_dir }}"
    src: "UUID={{ rollup_disk_uuid.stdout }}"
    fstype: ext4
    opts: "defaults,noatime"
    passno: "2"
    state: mounted
  become: true
  when:
    - not (disk_config.use_raid | default(false) | bool)
    - disk_config.rollup_disk | default('') | length > 0
    - rollup_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: set rollup storage ownership
  file:
    path: "{{ rollup_storage_dir }}"
    state: directory
    owner: sovereign
    group: sovereign
  become: true
  when: disk_config.rollup_disk | default('') | length > 0 or (disk_config.use_raid | default(false) | bool)

# =============================================================================
# PHASE 5: Setup Logs Disk
# =============================================================================

- name: unmount logs disk for reformat
  mount:
    path: "{{ rollup_log_dir }}"
    state: unmounted
  become: true
  when:
    - reformat_disks | default(false) | bool
    - logs_mount_state.stdout == 'mounted'
    - disk_config.logs_disk | default('') | length > 0

- name: format logs disk
  filesystem:
    fstype: ext4
    dev: "{{ disk_config.logs_disk }}"
    force: "{{ reformat_disks | default(false) }}"
  become: true
  when:
    - disk_config.logs_disk | default('') | length > 0
    - logs_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: get logs disk UUID
  command: blkid -s UUID -o value {{ disk_config.logs_disk }}
  register: logs_disk_uuid
  changed_when: false
  become: true
  when: disk_config.logs_disk | default('') | length > 0

- name: mount logs disk
  mount:
    path: "{{ rollup_log_dir }}"
    src: "UUID={{ logs_disk_uuid.stdout }}"
    fstype: ext4
    opts: "defaults,noatime"
    passno: "2"
    state: mounted
  become: true
  when:
    - disk_config.logs_disk | default('') | length > 0
    - logs_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: set logs directory ownership
  file:
    path: "{{ rollup_log_dir }}"
    state: directory
    owner: sovereign
    group: sovereign
  become: true
  when: disk_config.logs_disk | default('') | length > 0

# =============================================================================
# PHASE 6: Setup DA Disk
# =============================================================================

- name: unmount da disk for reformat
  mount:
    path: "{{ da_store }}"
    state: unmounted
  become: true
  when:
    - reformat_disks | default(false) | bool
    - da_mount_state.stdout == 'mounted'
    - disk_config.da_disk | default('') | length > 0

- name: format da disk
  filesystem:
    fstype: ext4
    dev: "{{ disk_config.da_disk }}"
    force: "{{ reformat_disks | default(false) }}"
  become: true
  when:
    - disk_config.da_disk | default('') | length > 0
    - da_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: get da disk UUID
  command: blkid -s UUID -o value {{ disk_config.da_disk }}
  register: da_disk_uuid
  changed_when: false
  become: true
  when: disk_config.da_disk | default('') | length > 0

- name: mount da disk
  mount:
    path: "{{ da_store }}"
    src: "UUID={{ da_disk_uuid.stdout }}"
    fstype: ext4
    opts: "defaults,noatime"
    passno: "2"
    state: mounted
  become: true
  when:
    - disk_config.da_disk | default('') | length > 0
    - da_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: set da directory ownership
  file:
    path: "{{ da_store }}"
    state: directory
    owner: sovereign
    group: sovereign
  become: true
  when: disk_config.da_disk | default('') | length > 0

# =============================================================================
# PHASE 7: Setup Snapshots Disk
# =============================================================================

- name: unmount snapshots disk for reformat
  mount:
    path: "{{ snapshots_dir }}"
    state: unmounted
  become: true
  when:
    - reformat_disks | default(false) | bool
    - snapshots_mount_state.stdout == 'mounted'
    - disk_config.snapshots_disk | default('') | length > 0

- name: format snapshots disk
  filesystem:
    fstype: ext4
    dev: "{{ disk_config.snapshots_disk }}"
    force: "{{ reformat_disks | default(false) }}"
  become: true
  when:
    - disk_config.snapshots_disk | default('') | length > 0
    - snapshots_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: get snapshots disk UUID
  command: blkid -s UUID -o value {{ disk_config.snapshots_disk }}
  register: snapshots_disk_uuid
  changed_when: false
  become: true
  when: disk_config.snapshots_disk | default('') | length > 0

- name: mount snapshots disk
  mount:
    path: "{{ snapshots_dir }}"
    src: "UUID={{ snapshots_disk_uuid.stdout }}"
    fstype: ext4
    opts: "defaults,noatime"
    passno: "2"
    state: mounted
  become: true
  when:
    - disk_config.snapshots_disk | default('') | length > 0
    - snapshots_mount_state.stdout == 'not_mounted' or (reformat_disks | default(false) | bool)

- name: set snapshots directory ownership
  file:
    path: "{{ snapshots_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
  become: true
  when: disk_config.snapshots_disk | default('') | length > 0

# =============================================================================
# PHASE 8: Display RAID Status
# =============================================================================

- name: get RAID sync status
  shell: cat /proc/mdstat 2>/dev/null || echo "No RAID arrays"
  register: mdstat
  changed_when: false
  become: true
  when: disk_config.use_raid | default(false) | bool

- name: display RAID sync status
  debug:
    msg:
      - "===== RAID Sync Status ====="
      - "{{ mdstat.stdout_lines }}"
      - ""
      - "Note: RAID sync runs in background. Array is immediately usable."
      - "Monitor: cat /proc/mdstat"
  when: disk_config.use_raid | default(false) | bool
