---
# Auto-discover disks by model name pattern
# Uses disk_profile_raw.disk_model to filter disks from lsblk output

- name: display disk model pattern
  debug:
    msg: "Searching for disks matching model: '{{ disk_profile_raw.disk_model }}'"

- name: discover disks by model
  shell: |
    lsblk -d -o NAME,MODEL -n | grep "{{ disk_profile_raw.disk_model }}" | awk '{print "/dev/" $1}' | sort
  register: disk_discovery
  changed_when: false

- name: set discovered disks
  set_fact:
    discovered_instance_store_disks: "{{ disk_discovery.stdout_lines }}"

- name: display discovered disks
  debug:
    msg:
      - "===== Disk Discovery ====="
      - "Model pattern: '{{ disk_profile_raw.disk_model }}'"
      - "Found {{ discovered_instance_store_disks | length }} disk(s):"
      - "{{ discovered_instance_store_disks }}"

- name: validate sufficient disks for RAID
  fail:
    msg: >
      Not enough instance store disks for RAID configuration.
      Required: {{ disk_profile_raw.raid_disk_count }} disks for RAID.
      Found: {{ discovered_instance_store_disks | length }} disk(s).
  when:
    - disk_profile_raw.use_raid | default(false)
    - discovered_instance_store_disks | length < disk_profile_raw.raid_disk_count | int

- name: validate logs disk index
  fail:
    msg: >
      Logs disk index {{ disk_profile_raw.logs_disk_index }} is out of range.
      Found {{ discovered_instance_store_disks | length }} disk(s) (indices 0-{{ discovered_instance_store_disks | length - 1 }}).
  when:
    - disk_profile_raw.logs_disk_index is not none
    - discovered_instance_store_disks | length <= disk_profile_raw.logs_disk_index | int

- name: validate da disk index
  fail:
    msg: >
      DA disk index {{ disk_profile_raw.da_disk_index }} is out of range.
      Found {{ discovered_instance_store_disks | length }} disk(s) (indices 0-{{ discovered_instance_store_disks | length - 1 }}).
  when:
    - disk_profile_raw.da_disk_index is not none
    - discovered_instance_store_disks | length <= disk_profile_raw.da_disk_index | int
