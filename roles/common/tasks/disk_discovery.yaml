---
# Auto-discover disks by model name pattern and/or EBS serial prefix
# - disk_model: Matches lsblk MODEL column (e.g., "Amazon EC2 NVMe Instance Storage")
# - ebs_serial_prefix: Matches NVMe serial number prefix (e.g., "vol" for EBS volumes)

- name: display discovery parameters
  debug:
    msg:
      - "Disk model pattern: '{{ disk_profile_raw.disk_model | default('N/A') }}'"
      - "EBS serial prefix: '{{ disk_profile_raw.ebs_serial_prefix | default('N/A') }}'"

- name: discover instance store disks by model
  shell: |
    lsblk -d -o NAME,MODEL -n | grep "{{ disk_profile_raw.disk_model }}" | awk '{print "/dev/" $1}' | sort
  register: disk_discovery
  changed_when: false
  when: disk_profile_raw.disk_model is defined

- name: set discovered instance store disks
  set_fact:
    discovered_instance_store_disks: "{{ disk_discovery.stdout_lines | default([]) }}"

- name: initialize discovered_ebs_disk
  set_fact:
    discovered_ebs_disk: ""

- name: discover EBS disks by serial prefix
  shell: |
    for dev in $(lsblk -d -o NAME -n | grep '^nvme'); do
      # Skip disks with partitions (likely root volume)
      if lsblk -n "/dev/$dev" | grep -q ' part '; then
        continue
      fi
      serial=$(nvme id-ctrl -v "/dev/$dev" 2>/dev/null | grep -i "^sn" | awk '{print $3}' | tr -d ' ')
      case "$serial" in
        {{ disk_profile_raw.ebs_serial_prefix }}*)
          echo "/dev/$dev"
          exit 0
          ;;
      esac
    done
  register: ebs_discovery
  changed_when: false
  become: true
  when: disk_profile_raw.ebs_serial_prefix is defined

- name: set discovered EBS disk
  set_fact:
    discovered_ebs_disk: "{{ ebs_discovery.stdout | default('') }}"
  when: disk_profile_raw.ebs_serial_prefix is defined

- name: display discovered disks
  debug:
    msg:
      - "===== Disk Discovery Results ====="
      - "Instance store disks ({{ discovered_instance_store_disks | length }}): {{ discovered_instance_store_disks | join(', ') or 'none' }}"
      - "EBS disk: {{ discovered_ebs_disk | default('N/A') }}"

- name: validate sufficient disks for standard RAID
  fail:
    msg: >
      Not enough instance store disks for RAID configuration.
      Required: {{ disk_profile_raw.raid_disk_count }} disks for RAID.
      Found: {{ discovered_instance_store_disks | length }} disk(s).
  when:
    - disk_profile_raw.use_raid | default(false)
    - not (disk_profile_raw.raid_write_mostly | default(false))
    - discovered_instance_store_disks | length < disk_profile_raw.raid_disk_count | int

- name: validate disks for write-mostly RAID (NVMe + EBS)
  fail:
    msg: >
      Write-mostly RAID requires 1 NVMe instance store and 1 EBS volume.
      Found: {{ discovered_instance_store_disks | length }} instance store disk(s), EBS: {{ discovered_ebs_disk | default('none') }}.
  when:
    - disk_profile_raw.raid_write_mostly | default(false)
    - discovered_instance_store_disks | length < 1 or (discovered_ebs_disk | default('')) == ''

- name: validate rollup disk index
  fail:
    msg: >
      Rollup disk index {{ disk_profile_raw.rollup_disk_index }} is out of range.
      Found {{ discovered_instance_store_disks | length }} disk(s) (indices 0-{{ discovered_instance_store_disks | length - 1 }}).
  when:
    - disk_profile_raw.rollup_disk_index is defined
    - disk_profile_raw.rollup_disk_index is not none
    - discovered_instance_store_disks | length <= disk_profile_raw.rollup_disk_index | int

- name: validate logs disk index
  fail:
    msg: >
      Logs disk index {{ disk_profile_raw.logs_disk_index }} is out of range.
      Found {{ discovered_instance_store_disks | length }} disk(s) (indices 0-{{ discovered_instance_store_disks | length - 1 }}).
  when:
    - disk_profile_raw.logs_disk_index is defined
    - disk_profile_raw.logs_disk_index is not none
    - discovered_instance_store_disks | length <= disk_profile_raw.logs_disk_index | int

- name: validate da disk index
  fail:
    msg: >
      DA disk index {{ disk_profile_raw.da_disk_index }} is out of range.
      Found {{ discovered_instance_store_disks | length }} disk(s) (indices 0-{{ discovered_instance_store_disks | length - 1 }}).
  when:
    - disk_profile_raw.da_disk_index is defined
    - disk_profile_raw.da_disk_index is not none
    - discovered_instance_store_disks | length <= disk_profile_raw.da_disk_index | int

- name: validate EBS disk for snapshots
  fail:
    msg: >
      Snapshots disk requires an EBS volume but none was found.
      Ensure an EBS volume with serial prefix '{{ disk_profile_raw.ebs_serial_prefix }}' is attached.
  when:
    - disk_profile_raw.snapshots_disk_from_ebs | default(false)
    - (discovered_ebs_disk | default('')) == ''

- name: validate snapshots and write-mostly RAID are mutually exclusive
  fail:
    msg: >
      Cannot use snapshots_disk_from_ebs with raid_write_mostly.
      Both options require the EBS volume, but only one EBS disk is discovered.
      Use either aws_ebs_backup_node (NVMe RAID + EBS snapshots) or aws_raid_ebs (NVMe+EBS RAID), not both.
  when:
    - disk_profile_raw.snapshots_disk_from_ebs | default(false)
    - disk_profile_raw.raid_write_mostly | default(false)

- name: validate snapshots requires standard sequencer
  fail:
    msg: >
      Snapshots disk (snapshots_disk_from_ebs) requires a standard sequencer.
      Current configuration: rollup_sequencer_kind={{ rollup_sequencer_kind | default('preferred') }}
      Set rollup_sequencer_kind: "standard" to use the backup node profile.
  when:
    - disk_profile_raw.snapshots_disk_from_ebs | default(false)
    - (rollup_sequencer_kind | default('preferred')) != 'standard'
