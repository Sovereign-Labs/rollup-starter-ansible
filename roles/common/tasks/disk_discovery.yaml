---
# Auto-discover disks by model name pattern and/or EBS serial prefix
# - disk_model: Matches lsblk MODEL column (e.g., "Amazon EC2 NVMe Instance Storage")
# - ebs_serial_prefix: Matches NVMe serial number prefix (e.g., "vol" for EBS volumes)

- name: display discovery parameters
  debug:
    msg:
      - "Disk model pattern: '{{ disk_profile_raw.disk_model | default('N/A') }}'"
      - "EBS serial prefix: '{{ disk_profile_raw.ebs_serial_prefix | default('N/A') }}'"

- name: discover instance store disks by model
  shell: |
    lsblk -d -o NAME,MODEL -n | grep "{{ disk_profile_raw.disk_model }}" | awk '{print "/dev/" $1}' | sort
  register: disk_discovery
  changed_when: false
  when: disk_profile_raw.disk_model is defined

- name: set discovered instance store disks
  set_fact:
    discovered_instance_store_disks: "{{ disk_discovery.stdout_lines | default([]) }}"

- name: discover EBS disks by serial prefix
  shell: |
    for dev in $(lsblk -d -o NAME -n | grep '^nvme'); do
      serial=$(nvme id-ctrl -v /dev/$dev 2>/dev/null | grep -i "^sn" | awk '{print $3}' | tr -d ' ')
      if [[ "$serial" == {{ disk_profile_raw.ebs_serial_prefix }}* ]]; then
        echo "/dev/$dev"
      fi
    done | head -1
  register: ebs_discovery
  changed_when: false
  become: true
  when: disk_profile_raw.ebs_serial_prefix is defined

- name: set discovered EBS disk
  set_fact:
    discovered_ebs_disk: "{{ ebs_discovery.stdout | default('') }}"
  when: disk_profile_raw.ebs_serial_prefix is defined

- name: display discovered disks
  debug:
    msg:
      - "===== Disk Discovery Results ====="
      - "Instance store disks ({{ discovered_instance_store_disks | length }}): {{ discovered_instance_store_disks | join(', ') or 'none' }}"
      - "EBS disk: {{ discovered_ebs_disk | default('N/A') }}"

- name: validate sufficient disks for standard RAID
  fail:
    msg: >
      Not enough instance store disks for RAID configuration.
      Required: {{ disk_profile_raw.raid_disk_count }} disks for RAID.
      Found: {{ discovered_instance_store_disks | length }} disk(s).
  when:
    - disk_profile_raw.use_raid | default(false)
    - not (disk_profile_raw.raid_write_mostly | default(false))
    - discovered_instance_store_disks | length < disk_profile_raw.raid_disk_count | int

- name: validate disks for write-mostly RAID (NVMe + EBS)
  fail:
    msg: >
      Write-mostly RAID requires 1 NVMe instance store and 1 EBS volume.
      Found: {{ discovered_instance_store_disks | length }} instance store disk(s), EBS: {{ discovered_ebs_disk | default('none') }}.
  when:
    - disk_profile_raw.raid_write_mostly | default(false)
    - discovered_instance_store_disks | length < 1 or (discovered_ebs_disk | default('')) == ''

- name: validate logs disk index
  fail:
    msg: >
      Logs disk index {{ disk_profile_raw.logs_disk_index }} is out of range.
      Found {{ discovered_instance_store_disks | length }} disk(s) (indices 0-{{ discovered_instance_store_disks | length - 1 }}).
  when:
    - disk_profile_raw.logs_disk_index is defined
    - disk_profile_raw.logs_disk_index is not none
    - discovered_instance_store_disks | length <= disk_profile_raw.logs_disk_index | int

- name: validate da disk index
  fail:
    msg: >
      DA disk index {{ disk_profile_raw.da_disk_index }} is out of range.
      Found {{ discovered_instance_store_disks | length }} disk(s) (indices 0-{{ discovered_instance_store_disks | length - 1 }}).
  when:
    - disk_profile_raw.da_disk_index is defined
    - disk_profile_raw.da_disk_index is not none
    - discovered_instance_store_disks | length <= disk_profile_raw.da_disk_index | int
