---
# Build rollup binary with selected DA and zkVM features
- name: build sovereign rollup binary
  become: true
  become_user: ubuntu
  vars:
    build_profile_flag: "{{ '--release' if not debug else '' }}"
  shell: source /home/ubuntu/.cargo/env && cargo build {{ build_profile_flag }} --bin {{ rollup_bin }} --no-default-features --features {{ da_feature }},{{ zkvm_role }}
  args:
    chdir: /home/ubuntu/{{ rollup_repo_dir }}
    executable: /bin/bash
  register: build_result
  async: 3600  # Allow up to 1 hour for build
  poll: 30     # Check status every 30 seconds

- name: verify binary was built successfully
  stat:
    path: "/home/ubuntu/{{ rollup_repo_dir }}/target/{{ 'release' if not debug else 'debug' }}/{{ rollup_bin }}"
  register: binary_stat
  become: true

- name: fail if binary was not built
  fail:
    msg: "Build failed or binary not found at {{ rollup_repo_dir }}/target/{{ 'release' if not debug else 'debug' }}/{{ rollup_bin }}"
  when: not binary_stat.stat.exists

- name: stop rollup service before replacing binary
  ansible.builtin.systemd:
    name: rollup
    state: stopped
  become: true
  ignore_errors: true
  failed_when: false

- name: copy rollup binary to sovereign's home directory
  vars:
    build_profile_path: "{{ 'release' if not debug else 'debug' }}"
  ansible.builtin.shell:
    cmd: cp /home/ubuntu/{{ rollup_repo_dir }}/target/{{ build_profile_path }}/{{ rollup_bin }} /home/sovereign/{{ rollup_bin }}
  become: true
  become_user: root

- name: set owner, group, and permissions on the node binary
  ansible.builtin.file:
    path: /home/sovereign/{{ rollup_bin }}
    owner: sovereign
    group: sovereign
    mode: '0755'
  become: true
  become_user: root
