# =============================================================================
# HTTP Base Configuration
# Included in the http {} block of main OpenResty config
# =============================================================================

# -----------------------------------------------------------------------------
# MIME Types and Defaults
# -----------------------------------------------------------------------------
include /usr/local/openresty/nginx/conf/mime.types;
default_type application/json;

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for" '
                'rt=$request_time backend=$upstream_addr';

access_log /var/log/nginx/access.log main;

# -----------------------------------------------------------------------------
# Connection Settings
# -----------------------------------------------------------------------------
sendfile           on;
tcp_nopush         on;
tcp_nodelay        on;
keepalive_timeout  65;
keepalive_requests 1000;

# -----------------------------------------------------------------------------
# Buffer Sizes
# -----------------------------------------------------------------------------
client_body_buffer_size    128k;
client_max_body_size       1m;
client_header_buffer_size  1k;
large_client_header_buffers 4 4k;

# -----------------------------------------------------------------------------
# Compression
# -----------------------------------------------------------------------------
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types
    application/json
    application/javascript
    application/xml
    application/xml+rss
    text/css
    text/javascript
    text/plain
    text/xml;

# -----------------------------------------------------------------------------
# Proxy Settings
# -----------------------------------------------------------------------------
proxy_buffering        on;
proxy_buffer_size      64k;
proxy_buffers          8 64k;
proxy_busy_buffers_size 128k;
proxy_http_version     1.1;

{% if proxy_dns_resolver | length > 0 %}
# DNS resolver for dynamic upstream resolution
resolver {{ proxy_dns_resolver }} valid=10s;
{% endif %}

# -----------------------------------------------------------------------------
# WebSocket Support
# -----------------------------------------------------------------------------
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# -----------------------------------------------------------------------------
# Backend Configuration (Lua)
# -----------------------------------------------------------------------------
lua_shared_dict backend_cache 1m;

init_worker_by_lua_block {
    -- Set backend addresses (leader handles writes, follower handles reads)
    local cache = ngx.shared.backend_cache
    cache:set("leader", "{{ proxy_rollup_leader_ip }}:{{ proxy_backend_port }}")
{% if proxy_rollup_follower_ip | length > 0 %}
    cache:set("follower", "{{ proxy_rollup_follower_ip }}:{{ proxy_backend_port }}")
{% else %}
    cache:set("follower", "{{ proxy_rollup_leader_ip }}:{{ proxy_backend_port }}")
{% endif %}
}

{% if proxy_rate_limit_enabled %}
# -----------------------------------------------------------------------------
# Rate Limiting
# -----------------------------------------------------------------------------

# IP addresses exempt from rate limiting
geo $ip_exempt {
    default 0;
{% for ip in proxy_rate_limit_exempt_ips %}
    {{ ip }} 1;
{% endfor %}
}

# Hostnames exempt from rate limiting (additional domains)
map $host $host_exempt {
    default 0;
{% if proxy_domain_name is defined and proxy_domain_name | length > 0 %}
    "{{ proxy_domain_name }}" 1;
{% endif %}
{% for domain in proxy_additional_domains %}
    "{{ domain }}" 1;
{% endfor %}
}

# Combined exemption check: bypass rate limiting if IP OR host is exempt
# Key format: "$ip_exempt:$host_exempt" (e.g., "0:0", "1:0", "0:1", "1:1")
# Only "0:0" applies rate limiting; all other combinations bypass
map "$ip_exempt:$host_exempt" $rate_limit_key {
    "0:0"   $binary_remote_addr;
    default "";
}

# Rate limiting zone: {{ proxy_rate_limit_rate }} per IP
limit_req_zone $rate_limit_key zone=global_limit:10m rate={{ proxy_rate_limit_rate }};
{% endif %}
