#!/bin/bash
#
# Make Leader Script
# Promotes this rollup node to leader by setting node_role = Leader.
#
set -euo pipefail

CONFIG_FILE="{{ rollup_config_path }}"

echo "=== Make Leader Script ==="
echo ""

if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "ERROR: Config file not found: $CONFIG_FILE" >&2
    exit 1
fi

# Check current state
if grep -q '^node_role = Leader' "$CONFIG_FILE"; then
    echo "Node is already configured as leader (node_role = Leader)"
    exit 0
fi

echo "Updating $CONFIG_FILE..."
sudo sed -i 's/^node_role = Replica$/node_role = Leader/' "$CONFIG_FILE"

# Verify the change was made
if ! grep -q '^node_role = Leader' "$CONFIG_FILE"; then
    echo "ERROR: Failed to update node_role setting" >&2
    exit 1
fi

echo "Successfully set node_role = Leader"
echo ""
echo "Restarting rollup service..."
sudo systemctl restart rollup

echo ""
echo "=== Done ==="
echo "Node is now configured as leader."
