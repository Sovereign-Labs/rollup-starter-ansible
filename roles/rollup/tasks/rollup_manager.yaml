---
# Clone and build the rollup manager binary

- name: checkout rollup manager repo
  become: true
  become_user: ubuntu
  git:
    repo: "{{ rollup_manager_repo }}"
    dest: "/home/ubuntu/{{ rollup_manager_repo_dir }}"
    version: "{{ rollup_manager_commit_hash if (rollup_manager_commit_hash is defined and rollup_manager_commit_hash | length > 0) else rollup_manager_branch }}"
    accept_hostkey: yes
    force: yes

- name: build rollup manager binary
  become: true
  become_user: ubuntu
  vars:
    build_profile_flag: "{{ '--release' if not debug else '' }}"
  shell: source /home/ubuntu/.cargo/env && cargo build {{ build_profile_flag }} --bin sov-rollup-manager
  args:
    chdir: /home/ubuntu/{{ rollup_manager_repo_dir }}
    executable: /bin/bash
  register: manager_build_result
  async: 1800  # Allow up to 30 minutes for build
  poll: 30     # Check status every 30 seconds

- name: verify rollup manager binary was built successfully
  stat:
    path: "/home/ubuntu/{{ rollup_manager_repo_dir }}/target/{{ 'release' if not debug else 'debug' }}/sov-rollup-manager"
  register: manager_binary_stat
  become: true

- name: fail if rollup manager binary was not built
  fail:
    msg: "Build failed or binary not found at {{ rollup_manager_repo_dir }}/target/{{ 'release' if not debug else 'debug' }}/{{ rollup_manager_bin }}"
  when: not manager_binary_stat.stat.exists

- name: copy rollup manager binary to sovereign's home directory
  vars:
    build_profile_path: "{{ 'release' if not debug else 'debug' }}"
  ansible.builtin.shell:
    cmd: cp /home/ubuntu/{{ rollup_manager_repo_dir }}/target/{{ build_profile_path }}/sov-rollup-manager /home/sovereign/{{ rollup_manager_bin }}
  become: true
  become_user: root

- name: set owner, group, and permissions on the rollup manager binary
  ansible.builtin.file:
    path: /home/sovereign/{{ rollup_manager_bin }}
    owner: sovereign
    group: sovereign
    mode: '0755'
  become: true
  become_user: root

- name: render rollup-manager-config.json
  become: true
  become_user: sovereign
  ansible.builtin.template:
    src: "rollup-manager-config.json.j2"
    dest: "{{ rollup_manager_config_path }}"
