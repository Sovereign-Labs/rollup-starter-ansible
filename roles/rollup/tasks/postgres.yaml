---
# PostgreSQL installation and configuration
# Installs PostgreSQL, creates a database, and sets the connection string fact

- name: Install PostgreSQL
  apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
    update_cache: yes
  become: true

- name: Ensure PostgreSQL service is running
  systemd:
    name: postgresql
    state: started
    enabled: yes
  become: true

- name: Create rollup database
  become: true
  become_user: postgres
  community.postgresql.postgresql_db:
    name: "{{ postgres_db_name }}"
    state: present

- name: Create rollup database user
  become: true
  become_user: postgres
  community.postgresql.postgresql_user:
    name: "{{ postgres_db_user }}"
    password: "{{ postgres_db_password }}"
    state: present

- name: Grant all privileges on database to user
  become: true
  become_user: postgres
  community.postgresql.postgresql_privs:
    db: "{{ postgres_db_name }}"
    privs: ALL
    type: database
    role: "{{ postgres_db_user }}"

- name: Grant all privileges on schema public to user
  become: true
  become_user: postgres
  community.postgresql.postgresql_privs:
    db: "{{ postgres_db_name }}"
    privs: ALL
    type: schema
    objs: public
    role: "{{ postgres_db_user }}"

- name: Set PostgreSQL connection string fact
  set_fact:
    rollup_sequencer_postgres_connection_string: "postgresql://{{ postgres_db_user }}:{{ postgres_db_password }}@localhost/{{ postgres_db_name }}"

- name: Verify database connection via psql socket
  become: true
  become_user: postgres
  command: psql -d {{ postgres_db_name }} -c "SELECT 1;"
  changed_when: false
